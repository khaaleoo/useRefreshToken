!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var o in r)("object"==typeof exports?exports:e)[o]=r[o]}}(global,(()=>(()=>{var e={54:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Cli=t.ECliArgument=void 0;var o,n=r(254),i=r(17),s=r(634);(o=t.ECliArgument||(t.ECliArgument={})).entry="entry",o.root="root",o.tmp="tmp",o.tsc="tsc",o.logLevel="logLevel",o.output="output",o.testMode="testMode",o.force="force";var a=function(){function e(e){var t=this;this.launched=!1,this.tmpPassed=!1,this.args={entry:"index.ts",root:i.resolve(process.cwd()),tmp:"<TEMP>",tsc:"",logLevel:s.ELogLevel.info,force:!1,output:"index.d.ts",testMode:!1},e?(this.launched=!0,this.storeArguments(e)):(n.option(["e","entry"],"Entry/main package file before bundling, relative to project root").option(["r","root"],"NPM package directory containing package.json",this.args.root).option(["t","tmp"],"Directory for storing temporary information",this.args.tmp,(function(e){return e.includes("<")||(t.tmpPassed=!0),e})).option(["c","tsc"],"Passed through non-validated additional TSC options",this.args.tsc).option(["L","logLevel"],"Log level (error, warn, info, verbose, debug)",this.args.logLevel).option(["f","force"],"Ignores non-critical errors and attempts to at least partially generate typings",this.args.force).option(["o","output"],"Overrides recommended output target to a custom one",this.args.output).option(["m","testMode"],"Configures npm-dts for self-test",this.args.testMode).command("generate","Start generation",(function(e,r,o){t.launched=!0,t.storeArguments(o)})).example("npm-dts generate","Generates index.d.ts file and updates package.json for CWD.").example("npm-dts -r /your/project/path generate","Performs generation on a custom path."),n.parse(process.argv,{name:"npm-dts",mri:{},mainColor:"yellow",subColor:"dim"}),this.launched||n.showHelp())}return e.prototype.getArgument=function(e){return this.args[e]},e.prototype.setArgument=function(e,t){this.args[e]=t},e.prototype.storeArguments=function(e){void 0===e&&(e=this.args);for(var t=0,r=Object.keys(this.args);t<r.length;t++){var o=r[t];this.args[o]=Object.is(e[o],void 0)?this.args[o]:e[o]}},e}();t.Cli=a},796:function(e,t,r){var o,n=this&&this.__extends||(o=function(e,t){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},o(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}),i=this&&this.__awaiter||function(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))},s=this&&this.__generator||function(e,t){var r,o,n,i,s={label:0,sent:function(){if(1&n[0])throw n[1];return n[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,o&&(n=2&i[0]?o.return:i[0]?o.throw||((n=o.return)&&n.call(o),0):o.next)&&!(n=n.call(o,i[1])).done)return n;switch(o=0,n&&(i=[2&i[0],n.value]),i[0]){case 0:case 1:n=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,o=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!((n=(n=s.trys).length>0&&n[n.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!n||i[1]>n[0]&&i[1]<n[3])){s.label=i[1];break}if(6===i[0]&&s.label<n[1]){s.label=n[1],n=i;break}if(n&&s.label<n[2]){s.label=n[2],s.ops.push(i);break}n[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],o=0}finally{r=n=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.IBasePathType=t.Generator=void 0;var a,c=r(147),u=r(147),l=r(443),p=r(931),f=r(17),g=r(76),d=r(360),h=r(54),m=r(634),v=r(147),y=function(e){function t(t,r,o){void 0===r&&(r=null),void 0===o&&(o=!1);var n=e.call(this,t)||this;if(n.cacheContentEmptied=!0,n.throwErrors=o,null===r&&(r=!t),r){(0,m.init)("npm-dts",n.getLogLevel());var i=JSON.parse((0,u.readFileSync)((0,f.resolve)(__dirname,"..","package.json"),{encoding:"utf8"})),s="          npm-dts v".concat(i.version,"                "),a="          by Vytenis UrbonaviÄius                          ",c="                                                           ",l="___________________________________________________________";a=a.substring(0,s.length),c=c.substring(0,s.length),l=l.substring(0,s.length),(0,m.info)(" ".concat(l," ")),(0,m.info)("|".concat(c,"|")),(0,m.info)("|".concat(c,"|")),(0,m.info)("|".concat(s,"|")),(0,m.info)("|".concat(a,"|")),(0,m.info)("|".concat(c,"|")),(0,m.info)("|".concat(l,"|")),(0,m.info)(" ".concat(c," "))}return n}return n(t,e),t.prototype.generate=function(){return i(this,void 0,void 0,(function(){var e,t,r,o,n=this;return s(this,(function(a){switch(a.label){case 0:if((0,m.info)('Generating declarations for "'.concat(this.getRoot(),'"...')),e=!1,t=null,r=[],this.tmpPassed)return[3,4];(0,m.verbose)("Locating OS Temporary Directory..."),a.label=1;case 1:return a.trys.push([1,3,,4]),[4,new Promise((function(e){d.dir((function(t,o,i){if(t)throw(0,m.error)("Could not create OS Temporary Directory!"),n.showDebugError(t),t;(0,m.verbose)("OS Temporary Directory was located!"),n.setArgument(h.ECliArgument.tmp,(0,f.resolve)(o,"npm-dts")),r.push((function(){(0,m.verbose)("Deleting OS Temporary Directory..."),i(),(0,m.verbose)("OS Temporary Directory was deleted!")})),e()}))}))];case 2:return a.sent(),[3,4];case 3:return o=a.sent(),e=!0,t=o,[3,4];case 4:return e?[3,6]:[4,this._generate().catch((function(r){return i(n,void 0,void 0,(function(){var o;return s(this,(function(n){switch(n.label){case 0:return e=!0,o=this.getOutput(),(0,m.error)("Generation of ".concat(o," has failed!")),this.showDebugError(r),this.useForce()||(this.getLogLevel()===m.ELogLevel.debug?((0,m.info)("If issue is not severe, you can try forcing execution using force flag."),(0,m.info)('In case of command line usage, add "-f" as the first parameter.')):((0,m.info)("You should try running npm-dts with debug level logging."),(0,m.info)('In case of command line, debug mode is enabled using "-L debug".'))),this.cacheContentEmptied?[3,2]:[4,this.clearTempDir()];case 1:n.sent(),n.label=2;case 2:return t=r,[2]}}))}))}))];case 5:a.sent(),a.label=6;case 6:if(r.forEach((function(e){return e()})),e){if((0,m.error)("Generation failed!"),this.throwErrors)throw t||new Error("Generation failed!")}else(0,m.info)("Generation is completed!");return[2]}}))}))},t.prototype.showDebugError=function(e){e&&(e.stdout?(0,m.debug)("Error: \n".concat(e.stdout.toString())):(0,m.debug)("Error: \n".concat(JSON.stringify(e))))},t.prototype._generate=function(){return i(this,void 0,void 0,(function(){var e;return s(this,(function(t){switch(t.label){case 0:return[4,this.generateTypings()];case 1:return t.sent(),[4,this.combineTypings()];case 2:return e=t.sent(),e=this.addAlias(e),[4,this.storeResult(e)];case 3:return t.sent(),[2]}}))}))},t.prototype.getLogLevel=function(){var e=this.getArgument(h.ECliArgument.logLevel);return m.ELogLevel[e]?e:m.ELogLevel.info},t.prototype.getEntry=function(){return this.getArgument(h.ECliArgument.entry)},t.prototype.getRoot=function(){return(0,f.resolve)(this.getArgument(h.ECliArgument.root))},t.prototype.getTempDir=function(){return(0,f.resolve)(this.getArgument(h.ECliArgument.tmp))},t.prototype.getOutput=function(){return this.getArgument(h.ECliArgument.output)},t.prototype.useTestMode=function(){return this.getArgument(h.ECliArgument.testMode)},t.prototype.useForce=function(){return this.getArgument(h.ECliArgument.force)},t.prototype.makeTempDir=function(e){var t=this;void 0===e&&(e=5);var r=this.getTempDir();return(0,m.verbose)('Preparing "tmp" directory...'),new Promise((function(o,n){l(r).then((function(){t.cacheContentEmptied=!1,(0,m.verbose)('"tmp" directory was prepared!'),o()})).catch((function(i){(0,m.error)('Failed to create "'.concat(r,'"!')),t.showDebugError(i),e?((0,m.verbose)("Will retry in ".concat(100,"ms...")),setTimeout((function(){t.makeTempDir(e-1).then(o,n)}),100)):((0,m.error)("Stopped trying after ".concat(5," retries!")),n())}))}))},t.prototype.clearTempDir=function(){var e=this,t=this.getTempDir();return(0,m.verbose)('Cleaning up "tmp" directory...'),new Promise((function(r,o){g(t,(function(n){n?((0,m.error)('Could not clean up "tmp" directory at "'.concat(t,'"!')),e.showDebugError(n),o()):(e.cacheContentEmptied=!0,(0,m.verbose)('"tmp" directory was cleaned!'),r())}))}))},t.prototype.resetCacheDir=function(){var e=this;return(0,m.verbose)('Will now reset "tmp" directory...'),new Promise((function(t,r){e.clearTempDir().then((function(){e.makeTempDir().then(t,r)}),r)}))},t.prototype.generateTypings=function(){return i(this,void 0,void 0,(function(){var e,t,r=this;return s(this,(function(o){switch(o.label){case 0:return[4,this.resetCacheDir()];case 1:o.sent(),(0,m.verbose)("Generating per-file typings using TSC..."),e=this.getArgument(h.ECliArgument.tsc),t='tsc --declaration --emitDeclarationOnly --declarationDir "'+this.getTempDir()+'"'+(e.length?" ".concat(e):""),(0,m.debug)(t);try{p.execSync(t,{cwd:this.useTestMode()?(0,f.resolve)(__dirname,".."):this.getRoot()},(function(e,t,o){e?(r.useForce()?(0,m.warn)("TSC exited with errors!"):(0,m.error)("TSC exited with errors!"),r.showDebugError(e)):(t&&process.stdout.write(t),o&&process.stderr.write(o))}))}catch(e){if(!this.useForce())throw e;(0,m.warn)('Suppressing errors due to "force" flag!'),this.showDebugError(e),(0,m.warn)("Generated declaration files might not be valid!")}return(0,m.verbose)("Per-file typings have been generated using TSC!"),[2]}}))}))},t.prototype.getDeclarationFiles=function(e,t){var r=this;void 0===e&&(e=this.getTempDir()),void 0===t&&(t=[]),e===this.getTempDir()&&(0,m.verbose)("Loading list of generated typing files...");try{(0,c.readdirSync)(e).forEach((function(o){t=(0,c.statSync)((0,f.join)(e,o)).isDirectory()?r.getDeclarationFiles((0,f.join)(e,o),t):t.concat((0,f.join)(e,o))}))}catch(e){throw(0,m.error)("Failed to load list of generated typing files..."),this.showDebugError(e),e}return e===this.getTempDir()&&(0,m.verbose)("Successfully loaded list of generated typing files!"),t},t.prototype.getPackageDetails=function(){if(this.packageInfo)return this.packageInfo;(0,m.verbose)("Loading package.json...");var e=this.getRoot(),t=(0,f.resolve)(e,"package.json");try{this.packageInfo=JSON.parse((0,u.readFileSync)(t,{encoding:"utf8"}))}catch(e){throw(0,m.error)("Failed to read package.json at \"'".concat(t,"'\"")),this.showDebugError(e),e}return(0,m.verbose)("package.json information has been loaded!"),this.packageInfo},t.prototype.convertPathToModule=function(e,t){void 0===t&&(t={});var r=t.rootType,o=void 0===r?a.tmp:r,n=t.noPrefix,i=void 0!==n&&n,s=t.noExtensionRemoval,c=void 0!==s&&s,u=t.noExistenceCheck,l=void 0!==u&&u,p=this.getPackageDetails(),g=l||!c&&v.existsSync(e)&&v.lstatSync(e).isFile();return o===a.cwd?e=(0,f.relative)(process.cwd(),e):o===a.root?e=(0,f.relative)(this.getRoot(),e):o===a.tmp&&(e=(0,f.relative)(this.getTempDir(),e)),i||(e="".concat(p.name,"/").concat(e)),e=e.replace(/\\/g,"/"),g&&!c&&(e=(e=e.replace(/\.[^.]+$/g,"")).replace(/\.d$/g,"")),e},t.prototype.loadTypings=function(){var e=this,t={},r=this.getDeclarationFiles();return(0,m.verbose)("Loading declaration files and mapping to modules..."),r.forEach((function(r){var o=e.convertPathToModule(r);try{t[o]=(0,u.readFileSync)(r,{encoding:"utf8"})}catch(t){throw(0,m.error)("Could not load declaration file '".concat(r,"'!")),e.showDebugError(t),t}})),(0,m.verbose)("Loaded declaration files and mapped to modules!"),t},t.prototype.resolveImportSourcesAtLine=function(e,t,r){var o=t.match(e);if(o&&o[2].startsWith(".")){var n="../".concat(o[2]),i=(0,f.resolve)(r,n);i=this.convertPathToModule(i,{rootType:a.cwd,noPrefix:!0,noExtensionRemoval:!0}),this.moduleExists(i)||(i+="/index"),t=t.replace(e,"$1".concat(i,"$3"))}return t},t.prototype.resolveImportSources=function(e,t){var r=this,o=(e=(e=(e=e.replace(/\r\n/g,"\n")).replace(/\n\r/g,"\n")).replace(/\r/g,"\n")).split("\n");return(o=o.map((function(e){return e=r.resolveImportSourcesAtLine(/(from ['"])([^'"]+)(['"])/,e,t),r.resolveImportSourcesAtLine(/(import\(['"])([^'"]+)(['"]\))/,e,t)}))).join("\n")},t.prototype.combineTypings=function(){return i(this,void 0,void 0,(function(){var e,t,r=this;return s(this,(function(o){switch(o.label){case 0:return e=this.loadTypings(),[4,this.clearTempDir()];case 1:return o.sent(),this.moduleNames=Object.keys(e),(0,m.verbose)("Combining typings into single file..."),t=[],Object.entries(e).forEach((function(e){var o=e[0],n=e[1];n=n.replace(/declare /g,""),n=r.resolveImportSources(n,o),t.push("declare module '".concat(o,"' {\n").concat(n.replace(/^./gm,"  $&"),"\n}"))})),(0,m.verbose)("Combined typings into a single file!"),[2,t.join("\n")]}}))}))},t.prototype.moduleExists=function(e){return this.moduleNames.includes(e)},t.prototype.addAlias=function(e){(0,m.verbose)("Adding alias for main file of the package...");var t=this.getPackageDetails(),r=this.getEntry();if(!r)throw(0,m.error)("No entry file is available!"),new Error("No entry file is available!");var o=this.convertPathToModule((0,f.resolve)(this.getRoot(),r),{rootType:a.root,noExistenceCheck:!0});return e+="\ndeclare module '".concat(t.name,"' {\n")+"  import main = require('".concat(o,"');\n")+"  export = main;\n}",(0,m.verbose)("Successfully created alias for main file!"),e},t.prototype.storeResult=function(e){return i(this,void 0,void 0,(function(){var t,r,o,n,i;return s(this,(function(s){switch(s.label){case 0:t=this.getOutput(),r=this.getRoot(),o=(0,f.resolve)(r,t),n=(0,f.dirname)(o),(0,m.verbose)("Ensuring that output folder exists..."),(0,m.debug)('Creating output folder: "'.concat(n,'"...')),s.label=1;case 1:return s.trys.push([1,3,,4]),[4,l(n)];case 2:return s.sent(),[3,4];case 3:throw i=s.sent(),(0,m.error)('Failed to create "'.concat(n,'"!')),this.showDebugError(i),i;case 4:(0,m.verbose)("Output folder is ready!"),(0,m.verbose)("Storing typings into ".concat(t," file..."));try{(0,c.writeFileSync)(o,e,{encoding:"utf8"})}catch(e){throw(0,m.error)("Failed to create ".concat(t,"!")),this.showDebugError(e),e}return(0,m.verbose)("Successfully created ".concat(t," file!")),[2]}}))}))},t}(h.Cli);t.Generator=y,function(e){e.root="root",e.tmp="tmp",e.cwd="cwd"}(a=t.IBasePathType||(t.IBasePathType={}))},634:(e,t,r)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.init=t.debug=t.verbose=t.info=t.warn=t.error=t.ELogLevel=void 0;var o=r(773),n=r(773);o.addColors({error:"red",warn:"yellow",info:"cyan",debug:"green"});var i,s=!1;(i=t.ELogLevel||(t.ELogLevel={})).error="error",i.warn="warn",i.info="info",i.verbose="verbose",i.debug="debug",t.error=function(e){return s?(0,n.error)(e):null},t.warn=function(e){return s?(0,n.warn)(e):null},t.info=function(e){return s?(0,n.info)(e):null},t.verbose=function(e){return s?(0,n.verbose)(e):null},t.debug=function(e){return s?(0,n.debug)(e):null},t.init=function(e,t){o.configure({level:t,format:o.format.combine(o.format.colorize(),o.format.label({label:e}),o.format.timestamp(),o.format.prettyPrint(),o.format.printf((function(e){return"[".concat(e.label,"] [").concat(e.level,"] : ").concat(e.message)}))),transports:[new o.transports.Console]}),s=!0}},254:e=>{"use strict";e.exports=require("args")},443:e=>{"use strict";e.exports=require("mkdirp")},931:e=>{"use strict";e.exports=require("npm-run")},76:e=>{"use strict";e.exports=require("rimraf")},360:e=>{"use strict";e.exports=require("tmp")},773:e=>{"use strict";e.exports=require("winston")},147:e=>{"use strict";e.exports=require("fs")},17:e=>{"use strict";e.exports=require("path")}},t={};function r(o){var n=t[o];if(void 0!==n)return n.exports;var i=t[o]={exports:{}};return e[o].call(i.exports,i,i.exports,r),i.exports}var o={};return(()=>{var e=o;Object.defineProperty(e,"__esModule",{value:!0}),e.ELogLevel=e.Generator=void 0;var t=r(796);Object.defineProperty(e,"Generator",{enumerable:!0,get:function(){return t.Generator}});var n=r(634);Object.defineProperty(e,"ELogLevel",{enumerable:!0,get:function(){return n.ELogLevel}})})(),o})()));
//# sourceMappingURL=index.js.map